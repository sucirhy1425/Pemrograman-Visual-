Imports System.Globalization

Public Class Form1
    Private nilai1 As Double = 0
    Private operasi As String = ""
    Private mulaiInput As Boolean = True

    Private Sub Form1_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        ' Inisialisasi textbox
        TextBox1.Text = "0"
        TextBox1.ReadOnly = True
        TextBox1.TextAlign = HorizontalAlignment.Right

        ' Secara dinamis hubungkan event handler berdasarkan Text tombol.
        For Each ctrl As Control In Me.Controls
            If TypeOf ctrl Is Button Then
                Dim btn As Button = CType(ctrl, Button)
                Dim t As String = btn.Text.Trim()

                ' Angka 0-9
                If t.Length = 1 AndAlso Char.IsDigit(t(0)) Then
                    AddHandler btn.Click, AddressOf DigitClick
                ElseIf t = "." Then
                    AddHandler btn.Click, AddressOf DotClick
                ElseIf t = "+" OrElse t = "-" OrElse t.ToUpper() = "X" OrElse t = "*" OrElse t = "/" OrElse t = ":" OrElse t = "×" OrElse t = "÷" Then
                    AddHandler btn.Click, AddressOf OperatorClick
                ElseIf t = "=" Then
                    AddHandler btn.Click, AddressOf EqualsClick
                ElseIf t.ToUpper() = "C" Then
                    AddHandler btn.Click, AddressOf ClearClick
                ElseIf t = "←" OrElse t = "<" OrElse t.ToLower() = "back" Then
                    AddHandler btn.Click, AddressOf BackspaceClick
                ElseIf t = "+/-" OrElse t = "±" Then
                    AddHandler btn.Click, AddressOf PlusMinusClick
                End If
            End If
        Next
    End Sub

    ' Handler untuk tombol angka
    Private Sub DigitClick(sender As Object, e As EventArgs)
        Dim btn As Button = CType(sender, Button)
        Dim digit As String = btn.Text.Trim()

        If mulaiInput OrElse TextBox1.Text = "0" Then
            TextBox1.Text = digit
            mulaiInput = False
        Else
            TextBox1.Text &= digit
        End If
    End Sub

    ' Handler untuk titik/desimal
    Private Sub DotClick(sender As Object, e As EventArgs)
        If mulaiInput Then
            TextBox1.Text = "0."
            mulaiInput = False
            Return
        End If

        If Not TextBox1.Text.Contains(".") Then
            TextBox1.Text &= "."
        End If
    End Sub

    ' Handler operator (+ - X /)
    Private Sub OperatorClick(sender As Object, e As EventArgs)
        Dim btn As Button = CType(sender, Button)
        Dim opText As String = btn.Text.Trim()

        ' Parse nilai saat ini ke nilai1 (lebih aman)
        Dim temp As Double
        If Double.TryParse(TextBox1.Text, NumberStyles.Any, CultureInfo.InvariantCulture, temp) Then
            nilai1 = temp
        Else
            nilai1 = 0
        End If

        ' Normalisasi operator (X -> *, ÷/ : -> /)
        Select Case opText.ToUpper()
            Case "X", "×"
                operasi = "*"
            Case ":", "÷"
                operasi = "/"
            Case Else
                operasi = opText
        End Select

        mulaiInput = True
    End Sub

    ' Handler tombol =
    Private Sub EqualsClick(sender As Object, e As EventArgs)
        Dim nilai2 As Double
        If Not Double.TryParse(TextBox1.Text, NumberStyles.Any, CultureInfo.InvariantCulture, nilai2) Then
            nilai2 = 0
        End If

        Dim hasil As Double = 0
        Select Case operasi
            Case "+"
                hasil = nilai1 + nilai2
            Case "-"
                hasil = nilai1 - nilai2
            Case "*"
                hasil = nilai1 * nilai2
            Case "/"
                If Math.Abs(nilai2) < Double.Epsilon Then
                    MessageBox.Show("Tidak bisa dibagi 0!", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error)
                    Return
                End If
                hasil = nilai1 / nilai2
            Case Else
                ' Jika belum ada operator, tampilkan nilai saat ini
                hasil = nilai2
        End Select

        ' Format hasil: jika bilangan bulat jangan tampilkan .0
        If Math.Abs(hasil - Math.Round(hasil)) < 0.0000001 Then
            TextBox1.Text = CStr(Math.Round(hasil))
        Else
            TextBox1.Text = hasil.ToString(CultureInfo.InvariantCulture)
        End If

        ' Reset state
        mulaiInput = True
        operasi = ""
    End Sub

    ' Clear (C)
    Private Sub ClearClick(sender As Object, e As EventArgs)
        TextBox1.Text = "0"
        nilai1 = 0
        operasi = ""
        mulaiInput = True
    End Sub

    ' Backspace (←)
    Private Sub BackspaceClick(sender As Object, e As EventArgs)
        If TextBox1.Text.Length > 1 Then
            TextBox1.Text = TextBox1.Text.Substring(0, TextBox1.Text.Length - 1)
        Else
            TextBox1.Text = "0"
            mulaiInput = True
        End If
    End Sub

    ' Plus / Minus (ubah tanda)
    Private Sub PlusMinusClick(sender As Object, e As EventArgs)
        If TextBox1.Text.StartsWith("-") Then
            TextBox1.Text = TextBox1.Text.Substring(1)
        ElseIf TextBox1.Text <> "0" Then
            TextBox1.Text = "-" & TextBox1.Text
        End If
    End Sub
End Class
